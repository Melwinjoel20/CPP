{% extends "base.html" %}
{% load static %}

{% block hero %}{% endblock %}

{% block content %}

<div class="container mt-5">

  <h2 class="mb-4">ðŸ›’ Your Shopping Cart</h2>

  <!-- Container where all cart items will be loaded -->
  <div id="cart-container"></div>

  <!-- Cart total -->
  <div id="cart-total" class="mt-4"></div>

  <!-- Checkout Button (only shown when items exist) -->
  <div id="checkout-section" class="mt-4" style="display:none;">
   <a href="{% url 'checkout' %}" class="btn btn-success btn-lg w-100">
    Proceed to Checkout
    </a>
  </div>

</div>

{% endblock %}

{% block extra_scripts %}
<script>
const VIEW_CART_URL = "{{ VIEW_CART_URL }}";
const REMOVE_URL = "{{ REMOVE_ITEM_URL }}";
const USER_ID = "{{ request.session.user_id|default:'guest123' }}";
console.log("USER_ID=", USER_ID);


async function loadCart() {

    // Fetch all items for this user from Lambda
    const res = await fetch(VIEW_CART_URL + "?user_id=" + USER_ID);
    const items = await res.json();

    const container = document.getElementById("cart-container");
    const totalDiv = document.getElementById("cart-total");
    const checkout = document.getElementById("checkout-section");

    container.innerHTML = "";
    totalDiv.innerHTML = "";
    checkout.style.display = "none";

    if (!items.length) {
        container.innerHTML = `
            <div class="alert alert-info text-center">
                <strong>Your cart is empty!</strong><br>
                Browse products and add items to your cart.
            </div>`;
        return;
    }

    let total = 0;

    items.forEach(item => {
        total += item.price * (item.qty || 1);

        container.innerHTML += `
            <div class="card mb-3 shadow-sm border-0 p-3">
                <div class="d-flex justify-content-between align-items-center">
                    
                    <div>
                        <h5 class="fw-bold">${item.name}</h5>
                        <p class="text-muted small">â‚¬${item.price} Ã— ${item.qty || 1}</p>
                    </div>

                    <button 
                        class="btn btn-danger btn-sm remove-item-btn"
                        data-item-id="${item.item_id}"
                    >
                        Remove
                    </button>

                </div>
            </div>
        `;
    });

    totalDiv.innerHTML = `
        <h4 class="fw-bold">Total: â‚¬${total.toFixed(2)}</h4>
    `;

    checkout.style.display = "block";
}


// REMOVE ITEM
document.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("remove-item-btn")) return;

    const itemId = e.target.dataset.itemId;

    e.target.disabled = true;
    e.target.innerText = "Removing...";

    await fetch(REMOVE_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ item_id: itemId })
    });

    loadCart();
});

// Load cart on page load
loadCart();
</script>
{% endblock %}
