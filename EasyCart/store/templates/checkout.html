{% extends "base.html" %}
{% load static %}

{% block hero %}{% endblock %}

{% block content %}

<div class="container mt-5 mb-5">

    <h2 class="mb-4 fw-bold">üõç Checkout</h2>

    <div class="row">

        <!-- LEFT: CUSTOMER DETAILS -->
        <div class="col-md-7">

            <div class="card shadow-sm p-4 mb-4">

                <h4 class="fw-bold mb-3">Customer Details</h4>

                <form id="checkout-form">

                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="fullName" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="phone" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input type="text" class="form-control" id="country" value="Ireland" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Address Line 1</label>
                        <input type="text" class="form-control" id="address1" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Address Line 2</label>
                        <input type="text" class="form-control" id="address2">
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">City</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Postal Code</label>
                            <input type="text" class="form-control" id="postal" required>
                        </div>
                    </div>

                </form>

            </div>

            <!-- Payment Section -->
            <div class="card shadow-sm p-4 mb-4">

                <h4 class="fw-bold mb-3">Payment</h4>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="paymentMethod" value="card" checked>
                    <label class="form-check-label">Credit/Debit Card</label>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="paymentMethod" value="paypal">
                    <label class="form-check-label">PayPal</label>
                </div>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="paymentMethod" value="cod">
                    <label class="form-check-label">Cash on Delivery</label>
                </div>

            </div>

        </div>


        <!-- RIGHT: ORDER SUMMARY -->
        <div class="col-md-5">

            <div class="card shadow-sm p-4 mb-4">

                <h4 class="fw-bold mb-3">Order Summary</h4>

                <div id="order-items"></div>

                <hr>

                <p class="fw-bold fs-5">
                    Total: <span id="order-total" class="text-primary">‚Ç¨0.00</span>
                </p>

                <button type="button" class="btn btn-success w-100 mt-3" id="place-order-btn">
                    Place Order
                </button>

        </div>

    </div>

</div>

{% endblock %}

{% block extra_scripts %}
<script>

const VIEW_CART_URL = "{{ VIEW_CART_URL }}";
const PLACE_ORDER_URL = "{{ PLACE_ORDER_URL }}";
const USER_ID = "{{ request.session.user_id|default:'guest123' }}";

// üü¶ Load cart items for summary
async function loadOrderSummary() {
    const res = await fetch(`${VIEW_CART_URL}?user_id=${USER_ID}`);
    const items = await res.json();

    const container = document.getElementById("order-items");
    const totalSpan = document.getElementById("order-total");

    container.innerHTML = "";
    let total = 0;

    items.forEach(item => {
        total += item.price * (item.qty || 1);

        container.innerHTML += `
            <div class="d-flex justify-content-between mb-2">
                <span>${item.name} (√ó${item.qty || 1})</span>
                <span>‚Ç¨${item.price.toFixed(2)}</span>
            </div>
        `;
    });

    totalSpan.innerHTML = `‚Ç¨${total.toFixed(2)}`;
}


// üü© Place Order
document.getElementById("place-order-btn").addEventListener("click", async () => {

    // Gather customer form data
    const payload = {
        user_id: USER_ID,
        payment_method: document.querySelector("input[name='paymentMethod']:checked").value,
        customer: {
            full_name: document.getElementById("fullName").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            country: document.getElementById("country").value,
            address1: document.getElementById("address1").value,
            address2: document.getElementById("address2").value,
            city: document.getElementById("city").value,
            postal: document.getElementById("postal").value
        }
    };

    // Simple validation
    if (!payload.customer.full_name || !payload.customer.email) {
        alert("Please fill all required fields.");
        return;
    }

    // Disable button while processing
    const btn = document.getElementById("place-order-btn");
    btn.disabled = true;
    btn.innerText = "Processing...";

    try {
        const res = await fetch(PLACE_ORDER_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        if (res.status === 200) {
            alert("Order placed successfully! Order ID: " + data.order_id);
            window.location.href = "/store/order-confirmation/?id=" + data.order_id;
        } else {
            alert("Order failed: " + data.error);
        }

    } catch (err) {
        alert("Something went wrong while placing your order.");
    }

    btn.disabled = false;
    btn.innerText = "Place Order";
});


// Load summary at page load
loadOrderSummary();

</script>
{% endblock %}
